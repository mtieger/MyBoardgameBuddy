<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸš€ High Frontier â€” Game Setup</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <h1>ğŸš€ High Frontier</h1>
  <p class="subtitle">Game Setup â€” High Frontier 4 All</p>

  <div class="color-dots-preview">
    <div class="preview-dot" style="background:#f0f0f0"></div>
    <div class="preview-dot" style="background:#95a5a6"></div>
    <div class="preview-dot" style="background:#f1c40f"></div>
    <div class="preview-dot" style="background:#e74c3c"></div>
    <div class="preview-dot" style="background:#2ecc71"></div>
    <div class="preview-dot" style="background:#9b59b6"></div>
  </div>

  <!-- â”€â”€â”€ HOME SCREEN â”€â”€â”€ -->
  <div class="step-wrap anim-forward" id="screen-home">
    <div class="card home-card">
      <div class="home-btn-group">
        <button class="btn-home-primary" onclick="startGameSetup()">
          âš™ï¸ Game Setup
          <span class="home-btn-sub">Modules Â· Scenario Â· Players Â· Color Assignment</span>
        </button>
        <button class="btn-home-secondary" onclick="openFullRulebook()">
          ğŸ“– Rules Reference
          <span class="home-btn-sub">Browse rules, glossary &amp; card reference</span>
        </button>
        <button class="btn-home-secondary" onclick="openRulebook()">
          ğŸ“‹ My Session Rulebook
          <span class="home-btn-sub">Rules filtered for your active game config</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Progress indicator -->
  <div class="progress-wrap hidden" id="progress-wrap">
    <div class="progress-label">
      <span>Step <span id="prog-num">1</span> of <span id="prog-total">6</span></span>
      <span class="step-name" id="prog-name">Module Selection</span>
    </div>
    <div class="progress-bar-track">
      <div class="progress-bar-fill" id="prog-fill" style="width:16.67%"></div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 1: Module Selection â”€â”€â”€ -->
  <div class="step-wrap hidden" id="step-1">
    <div class="card">
      <div class="step-heading">Select Modules</div>
      <div class="step-subheading">Choose which expansion modules to include in your game.</div>
      <div class="module-list" id="module-list"></div>
      <div class="nav-row">
        <button class="btn-back" onclick="goToHome()">â† Back</button>
        <button class="btn-primary" onclick="goNext()">Next â†’</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 2: Scenario â”€â”€â”€ -->
  <div class="step-wrap hidden" id="step-2">
    <div class="card">
      <div class="step-heading">Choose a Scenario</div>
      <div class="step-subheading">Only scenarios compatible with your selected modules are shown.</div>
      <div class="scenario-grid" id="scenario-grid"></div>
      <div class="nav-row">
        <button class="btn-back" onclick="goBack()">â† Back</button>
        <button class="btn-primary" id="next-2" onclick="goNext()" disabled>Next â†’</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 3: Sub-options â”€â”€â”€ -->
  <div class="step-wrap hidden" id="step-3">
    <div class="card">
      <div class="step-heading" id="sub-heading">Scenario Options</div>
      <div class="step-subheading">Choose a variant for this scenario.</div>
      <div class="suboption-list" id="suboption-list"></div>
      <div class="nav-row">
        <button class="btn-back" onclick="goBack()">â† Back</button>
        <button class="btn-primary" id="next-3" onclick="goNext()" disabled>Next â†’</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 7: Variants â”€â”€â”€ -->
  <div class="step-wrap hidden" id="step-7">
    <div class="card">
      <div class="step-heading">Optional Rules</div>
      <div class="step-subheading">Toggle optional rules to customise your game. All are off by default â€” any combination is valid.</div>
      <div class="module-list" id="variant-list"></div>
      <div class="nav-row">
        <button class="btn-back" onclick="goBack()">â† Back</button>
        <button class="btn-primary" onclick="goNext()">Next â†’</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 4: Player Count â”€â”€â”€ -->
  <div class="step-wrap hidden" id="step-4">
    <div class="card">
      <div class="step-heading">How Many Players?</div>
      <div class="step-subheading" id="count-subheading">Choose the number of players.</div>
      <div id="count-ui"></div>
      <div class="nav-row">
        <button class="btn-back" onclick="goBack()">â† Back</button>
        <button class="btn-primary" onclick="goNext()">Next â†’</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 5: Player Names â”€â”€â”€ -->
  <div class="step-wrap hidden" id="step-5">
    <div class="card">
      <div class="step-heading">Player Names</div>
      <div class="step-subheading">Enter a name for each player, or leave blank for the default.</div>
      <div id="name-fields"></div>
      <div class="nav-row">
        <button class="btn-back" onclick="goBack()">â† Back</button>
        <button class="btn-primary" onclick="goNext()">Assign Colors â†’</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 6: Results â”€â”€â”€ -->
  <div class="step-wrap hidden" id="step-6">
    <div class="card">
      <div class="results-title">âœ¨ Ready to Play!</div>
      <div class="results-summary" id="game-summary"></div>
      <div id="player-list"></div>
      <div class="divider"></div>
      <button class="btn-secondary" onclick="openRulesAndAids()">ğŸ“– Rules &amp; Player Aids</button>
      <button class="btn-secondary" onclick="openRulebookFromGame()">ğŸ“‹ My Rulebook</button>
      <button class="btn-secondary" onclick="resetApp()">â†© Start Over</button>
    </div>
  </div>

  <!-- â”€â”€â”€ SESSION RULEBOOK SCREEN â”€â”€â”€ -->
  <div class="step-wrap hidden" id="screen-rulebook">
    <div class="card">
      <div class="nav-row" style="margin-bottom:14px">
        <button class="btn-back" onclick="closeRulebook()">â† Back</button>
        <div class="step-heading" style="margin:0">Session Rulebook</div>
      </div>
      <div id="rulebook-banner" class="rulebook-banner"></div>
      <input
        type="search"
        id="rulebook-search"
        class="rulebook-search"
        placeholder="Search rules by keywordâ€¦"
        oninput="filterRulebook(this.value)"
      >
      <div id="rulebook-list"></div>
    </div>
  </div>

  <!-- â”€â”€â”€ CREW CARDS SCREEN â”€â”€â”€ -->
  <div class="step-wrap hidden" id="screen-crew-cards">
    <div class="card">
      <div class="crew-screen-head" id="crew-cards-heading">Crew Cards</div>
      <div class="crew-screen-sub" id="crew-cards-sub">Choose which side of your Crew card to play as your faction.</div>
      <div class="crew-grid" id="crew-grid"></div>
      <div class="nav-row" style="margin-top:20px">
        <button class="btn-back" onclick="closeCrewCards()">â† Back to Ready</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ RULES & PLAYER AIDS SCREEN â”€â”€â”€ -->
  <div class="step-wrap hidden" id="screen-rules-and-aids">
    <div class="card home-card">
      <div class="step-heading" style="margin-bottom:22px">ğŸ“– Rules &amp; Player Aids</div>
      <div class="home-btn-group">
        <button class="btn-home-secondary" onclick="openRulesFromAids()">
          ğŸ“œ Rules
          <span class="home-btn-sub">Browse the session rulebook for your active game</span>
        </button>
        <button class="btn-home-secondary" onclick="openPlayerAidsFromAids()">
          ğŸ—‚ Player Aids
          <span class="home-btn-sub">Quick-reference cards, tables &amp; cheat sheets</span>
        </button>
      </div>
      <div class="nav-row" style="margin-top:22px">
        <button class="btn-back" onclick="closeRulesAndAids()">â† Back</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ RULES VIEWER SCREEN â”€â”€â”€ -->
  <div class="step-wrap hidden" id="screen-rules-viewer" style="max-width:700px">
    <div class="card">
      <div class="nav-row" style="margin-bottom:14px">
        <button class="btn-back" onclick="closeRulesViewer()">â† Back</button>
        <div class="step-heading" style="margin:0" id="rules-viewer-title">Session Rules</div>
      </div>
      <div class="rules-toggle-row" id="rules-toggle-row">
        <button class="rules-toggle-btn is-active" id="toggle-session" onclick="setRulesMode('session')">Session Rules</button>
        <button class="rules-toggle-btn" id="toggle-complete" onclick="setRulesMode('complete')">Complete Rules</button>
      </div>
      <div id="rules-viewer-banner" class="rulebook-banner"></div>
      <input
        type="search"
        id="rules-viewer-search"
        class="rulebook-search"
        placeholder="Search rules by keywordâ€¦"
        oninput="filterRulesViewer(this.value)"
      >
      <div id="rules-viewer-list"></div>
    </div>
  </div>

  <!-- â”€â”€â”€ RULES MODAL â”€â”€â”€ -->
  <div class="rules-modal-overlay hidden" id="rules-modal-overlay" onclick="closeRulesModal()">
    <div class="rules-modal" onclick="event.stopPropagation()">
      <div class="rules-modal-header">
        <div class="rules-modal-title" id="rules-modal-title">Rules</div>
        <button class="rules-modal-close" onclick="closeRulesModal()" aria-label="Close">âœ•</button>
      </div>
      <div class="rules-modal-body" id="rules-modal-body">
        <p class="rulebook-empty">Loadingâ€¦</p>
      </div>
    </div>
  </div>

  <script>
    // â”€â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const MODULES = [
      { id: 'core', label: 'Core',                      desc: 'Base game (always on)',                                                     alwaysOn: true  },
      { id: 'm0',   label: 'Module 0: Politics',         desc: 'Political board, laws, and faction agendas'                                                 },
      { id: 'm1',   label: 'Module 1: Terawatt & Futures', desc: 'Freighters, GW/TW thrusters, and Futures projects'                                       },
      { id: 'm2',   label: 'Module 2: Colonization',    desc: 'Bernals (orbital space stations) and Colonists'                                              },
      { id: 'm3',   label: 'Module 3: Conflict',         desc: 'Combat, War, and Anarchy rules'                                                             },
      { id: 'm4',   label: 'Module 4: Exodus',           desc: 'Contracts, Isobank, cybernetic implants, interstellar Exodus ship'                          },
      { id: 'm5',   label: 'Module 5: Economy',          desc: 'Corporate finance and stock market' },
    ];

    // Compatibility helpers
    const coreOnly      = mods => !['m0','m1','m2','m3','m4','m5'].some(m => mods.has(m));
    const noM0          = mods => !mods.has('m0');
    const always        = ()   => true;
    const needsM1M2     = mods => mods.has('m1') && mods.has('m2');
    const needsM3M4     = mods => mods.has('m3') && mods.has('m4');
    const needsM0M1M2M5 = mods => mods.has('m0') && mods.has('m1') && mods.has('m2') && mods.has('m5');
    const needsM0M5     = mods => mods.has('m0') && mods.has('m5');

    const SCENARIOS = [
      // â”€â”€ Core â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'space-diamonds', name: 'Space Diamonds', tag: 'Beginner', group: 'Core',
        desc: 'Lightweight family-friendly race through the solar system.',
        compat: coreOnly, subOptions: null, minPlayers: 1, maxPlayers: 6,
        ruleIds: ['V1'],
      },
      {
        id: 'race-for-glory', name: 'Race for Glory', tag: 'Introductory', group: 'Core',
        desc: 'Streamlined rules with a step-by-step walkthrough.',
        compat: coreOnly,
        subOptions: [
          { id: 'mars', label: 'Race to Mars',    desc: 'Shorter â€” Mars corridor only' },
          { id: 'top',  label: 'Race to the Top', desc: 'Full map, 48 turns'           },
        ],
        minPlayers: 1, maxPlayers: 6,
        ruleIds: [],
      },
      {
        id: 'standard', name: 'Standard Game', tag: 'Standard', group: 'Core',
        desc: 'The full High Frontier experience with any modules.',
        compat: always, subOptions: null, minPlayers: 1, maxPlayers: 6,
        ruleIds: [],
      },

      // â”€â”€ Variant Scenarios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'race-to-saturn', name: 'Race to Saturn', tag: 'Variant', group: 'Variant Scenarios',
        desc: 'First to land a Crew on Titan and return to LEO wins.',
        compat: always, subOptions: null, minPlayers: 2, maxPlayers: 6,
        ruleIds: ['V2'],
      },
      {
        id: 'grand-tour', name: 'Grand Tour', tag: 'Variant', group: 'Variant Scenarios',
        desc: 'Short game â€” 2 Seniority Disks, score only Claims and glory.',
        compat: always, subOptions: null, minPlayers: 2, maxPlayers: 6,
        ruleIds: ['V3'],
      },
      {
        id: 'red-giant', name: 'Red Giant', tag: 'Variant', group: 'Variant Scenarios',
        desc: 'Sol is going red giant. Inner solar system desiccates; only outer-system VP counts.',
        compat: always, subOptions: null, minPlayers: 2, maxPlayers: 6,
        ruleIds: ['V10'],
      },
      {
        id: 'diamonds-4-all', name: 'Diamonds 4 All', tag: 'Variant', group: 'Variant Scenarios',
        desc: 'Place discovery chits on Sites. Humans explore them for bonus VP and Abilities.',
        compat: always, subOptions: null, minPlayers: 1, maxPlayers: 6,
        ruleIds: ['V11'],
      },
      {
        id: 'panspermia', name: 'Panspermia', tag: 'Variant', group: 'Variant Scenarios',
        desc: 'Multiple alien species (Earthlings, Martians, Venusians, Sirens, Oceanians, Tholians, Nuclei) race the solar system.',
        compat: always, subOptions: null, minPlayers: 2, maxPlayers: 6,
        ruleIds: ['V12'],
      },

      // â”€â”€ Solo & Cooperative â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'altruism', name: 'Altruism', tag: 'SoloCoop', group: 'Solo & Cooperative',
        desc: 'Solo or cooperative. Reach a VP threshold to win.',
        compat: always,
        subOptions: [
          { id: 'solo', label: 'Solo',        desc: 'Single-player challenge'           },
          { id: 'coop', label: 'Cooperative', desc: 'Team up to reach the VP threshold' },
        ],
        minPlayers: 1, maxPlayers: 6,
        ruleIds: ['V4'],
      },
      {
        id: 'hermes-fall', name: 'Hermes Fall', tag: 'Solo', group: 'Solo & Cooperative',
        desc: 'Solo. Industrialize both Hermes sites before time runs out to deflect an asteroid.',
        compat: always, subOptions: null, minPlayers: 1, maxPlayers: 1,
        ruleIds: ['V5'],
      },
      {
        id: 'ceo', name: 'CEO', tag: 'Solo', group: 'Solo & Cooperative',
        desc: "Solo. Meet the Board's KPI at each Solar Cycle board meeting.",
        compat: always,
        subOptions: [
          { id: 'standard', label: 'Standard',     desc: 'Classic CEO challenge'        },
          { id: 'futures',  label: 'With Futures', desc: 'Requires Module 1 + Module 2' },
        ],
        minPlayers: 1, maxPlayers: 1,
        ruleIds: ['V6'],
      },

      // â”€â”€ Campaign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'bios-earth', name: 'Bios:Earth', tag: 'Campaign', group: 'Campaign',
        desc: 'Campaign continuation from the Bios trilogy â€” your Bios:Origins end-state determines starting conditions.',
        compat: always, subOptions: null, minPlayers: 1, maxPlayers: 6,
        ruleIds: ['V7'],
      },
      {
        id: 'bios-venus-mars', name: 'Bios:Venus / Bios:Mars', tag: 'Campaign', group: 'Campaign',
        desc: 'Start civilisation on Venus or Mars, then expand to the solar system.',
        compat: noM0,
        subOptions: [
          { id: 'venus', label: 'Venus', desc: 'Start the campaign on Venus' },
          { id: 'mars',  label: 'Mars',  desc: 'Start the campaign on Mars'  },
        ],
        minPlayers: 1, maxPlayers: 6,
        ruleIds: ['V8'],
      },
      {
        id: 'sirens', name: 'The Sirens', tag: 'Campaign', group: 'Campaign',
        desc: 'Carbon-based alien factions from Uranus explore the solar system.',
        compat: noM0, subOptions: null, minPlayers: 1, maxPlayers: 6,
        ruleIds: ['V9'],
      },

      // â”€â”€ Module 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'wernersstar', name: "Werner's Star", tag: 'Solo', group: 'Module 1',
        desc: "Solo. Werner dreams of the stars â€” win by completing a TW thruster Future before he dies of old age.",
        compat: mods => mods.has('m1'), subOptions: null, minPlayers: 1, maxPlayers: 1,
        ruleIds: ['1F', 'S-WernerStar'],
      },

      // â”€â”€ Modules 3 & 4 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'exodus-scenarios', name: 'Exodus Scenarios', tag: 'Wargame', group: 'Modules 3 & 4',
        desc: 'Total war between two factions. The losers are motivated to build a starship and escape the solar system.',
        compat: needsM3M4,
        subOptions: [
          { id: 'conventional', label: 'Conventional War', desc: 'Standard Module 3 conflict plus Exodus scoring' },
          { id: 'union',        label: 'Union War',        desc: 'Robots gain consciousness and join the Independence faction' },
        ],
        minPlayers: 2, maxPlayers: 6,
        ruleIds: ['4F', '4F1', '4F2', 'S-ExodusScenarios'],
      },

      // â”€â”€ Module 5 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'iso-dawn', name: 'Iso Dawn', tag: 'Module5', group: 'Module 5',
        desc: 'Start immediately after the stock market flips to isotope monetization. Requires Modules 0, 1, 2 & 5.',
        compat: needsM0M1M2M5, subOptions: null, minPlayers: 2, maxPlayers: 6,
        ruleIds: ['5J', 'S-IsoDawn'],
      },
      {
        id: 'taurus', name: "Roger's Taurus", tag: 'Solo', group: 'Module 5',
        desc: 'Solo/2-player. An NPC "Taurus" competes to chair every company. Requires Modules 0 & 5.',
        compat: needsM0M5, subOptions: null, minPlayers: 1, maxPlayers: 2,
        ruleIds: ['5L', 'S-Taurus'],
      },
    ];

    // â”€â”€â”€ VARIANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // forScenario: scenario id this variant only applies to (null = all scenarios)
    // group: used for color-coding on the Optional Rules page

    const VARIANTS = [
      // â”€â”€ Quick Start (shown on Variant Scenarios page) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'quick-start',
        label: 'Quick Start',
        desc: 'Accelerated early game â€” 0 starting Aqua, 12-year card-draw phase. Recommended for 4+ players.',
        requires: always,
        group: 'quick-start',
        forScenario: null,
        ruleIds: ['V1'],
      },

      // â”€â”€ Auction / Card Market rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'rapid-start',
        label: 'Rapid Start',
        desc: "4 rounds of patent auctions replace the first solar cycle. Start with 9 Aqua. Roger Lund's alternative to Quick Start.",
        requires: always,
        group: 'auction',
        forScenario: null,
        ruleIds: ['OPT-RapidStart', '5K'],
      },
      {
        id: 'open-cycle-generators',
        label: 'Open-Cycle Generators',
        desc: 'Dirt thrusters with an ISRU â‰¥ 5 can also function as generators. Adds a water-production option on any Site.',
        requires: mods => mods.has('m2'),
        group: 'auction',
        forScenario: null,
        ruleIds: ['2X1'],
      },
      {
        id: 'batteries',
        label: 'Batteries',
        desc: 'Any thruster can store energy as a battery charge to boost a future burn. Adds tactical resource management.',
        requires: mods => mods.has('m2'),
        group: 'auction',
        forScenario: null,
        ruleIds: ['2X2'],
      },
      {
        id: 'm4-contract-auctions',
        label: 'Contract Auctions Modifications',
        desc: 'Modifies how contracts are auctioned â€” see 4G1 for details.',
        requires: mods => mods.has('m4'),
        group: 'auction',
        forScenario: null,
        ruleIds: ['4G1'],
      },
      {
        id: 'm4-solitaire-contract-skip',
        label: 'Contract Auction Skipped',
        desc: 'In solitaire/cooperative, skip the contract auction step entirely.',
        requires: mods => mods.has('m4'),
        group: 'auction',
        forScenario: 'exodus-scenarios',
        ruleIds: ['OPT-M4Solitairec'],
      },

      // â”€â”€ General optional rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'realistic-solar-flux',
        label: 'Realistic Solar Flux',
        desc: 'Solar power varies with distance from the Sun. Cards with solar power icons produce less power in the outer solar system.',
        requires: mods => mods.has('m2'),
        group: 'general',
        forScenario: null,
        ruleIds: ['2X3'],
      },
      {
        id: 'risky-oberth',
        label: 'Risky Oberth Flybys',
        desc: 'Performing an Oberth flyby now risks a hazard roll. High reward, higher risk.',
        requires: mods => mods.has('m2'),
        group: 'general',
        forScenario: null,
        ruleIds: ['2X4'],
      },
      {
        id: 'torchship',
        label: 'Torchship Travel',
        desc: 'Spacecraft with sufficiently powerful thrusters can burn continuously, reaching any destination in one turn.',
        requires: mods => mods.has('m2'),
        group: 'general',
        forScenario: null,
        ruleIds: ['2X5'],
      },
      {
        id: 'diamonds-overlay',
        label: 'Diamonds 4 All Overlay',
        desc: 'Place discovery chits on Sites with special icons. Humans explore them during play for bonus VP and Abilities.',
        requires: always,
        group: 'general',
        forScenario: null,
        ruleIds: ['V11'],
      },
      {
        id: 'asteroid-jormungandr',
        label: 'Asteroid Jormungandr',
        desc: 'Place this optional asteroid tile anywhere in the Mars zone. Prospecting it with a Colonist grants a free augmentation chit.',
        requires: mods => mods.has('m4') || mods.has('m5'),
        group: 'general',
        forScenario: null,
        ruleIds: [],
      },
      {
        id: 'habitable-venus',
        label: 'Habitable Venus Overlay',
        desc: 'Use the Habitable Venus overlay card for an alternate Venus experience â€” relevant for Bios:Venus/Mars.',
        requires: always,
        group: 'general',
        forScenario: null,
        ruleIds: ['V8b'],
      },
      {
        id: 'piracy',
        label: 'Age of Piracy',
        desc: 'Experience combat without a full War of Independence. Felonies are freely permitted; no War/Anarchy outbreak needed.',
        requires: mods => mods.has('m3'),
        group: 'general',
        forScenario: null,
        ruleIds: ['3Ac', '3Ad'],
      },
      {
        id: 'modified-future-wars',
        label: 'Modified Future Wars',
        desc: 'Adjusts how Future-triggered wars escalate. Reduces snowball effects from early war outbreaks.',
        requires: mods => mods.has('m3'),
        group: 'general',
        forScenario: null,
        ruleIds: ['3Ae'],
      },

      // â”€â”€ Solitaire / specific-scenario variants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'alt-solitaire-politics',
        label: 'Alternative Solitaire Political Diagram',
        desc: 'Revised laws designed to reduce randomness in solo play. All ideologies become viable.',
        requires: mods => mods.has('m0') && mods.has('m4'),
        group: 'solitaire',
        forScenario: 'exodus-scenarios',
        ruleIds: ['4G3', 'OPT-M4Solitaire'],
      },
      {
        id: 'm4-solitaire-vp',
        label: 'Module 4 Solitaire VP Threshold',
        desc: 'Sets the VP threshold required to win in solitaire/cooperative Exodus play.',
        requires: mods => mods.has('m4'),
        group: 'solitaire',
        forScenario: 'exodus-scenarios',
        ruleIds: ['OPT-M4Solitaired'],
      },

      // â”€â”€ Module 5 variants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {
        id: 'm5-short',
        label: 'Module 5: Short Game (1â€“2 Seniority Disks)',
        desc: 'Use only 1â€“2 Seniority Disks instead of the default 3â€“4 for a faster Module 5 game.',
        requires: mods => mods.has('m5'),
        group: 'm5',
        forScenario: null,
        ruleIds: [],
      },
      {
        id: 'm5-jumpstart',
        label: 'Module 5: Jump Start',
        desc: 'Begin with pre-built starting Factories and Bernals per the Iso Dawn faction table. Recommended for experienced groups.',
        requires: mods => mods.has('m5'),
        group: 'm5',
        forScenario: null,
        ruleIds: [],
      },
    ];

    const COLORS = [
      { name: 'White',  hex: '#f0f0f0', shadow: 'rgba(240,240,240,0.5)', dark: true  },
      { name: 'Grey',   hex: '#95a5a6', shadow: 'rgba(149,165,166,0.5)', dark: false },
      { name: 'Yellow', hex: '#f1c40f', shadow: 'rgba(241,196,15,0.5)',  dark: true  },
      { name: 'Red',    hex: '#e74c3c', shadow: 'rgba(231,76,60,0.5)',   dark: false },
      { name: 'Green',  hex: '#2ecc71', shadow: 'rgba(46,204,113,0.5)',  dark: false },
      { name: 'Purple', hex: '#9b59b6', shadow: 'rgba(155,89,182,0.5)', dark: false },
    ];

    const STEP_NAMES = {
      1: 'Module Selection',
      2: 'Scenario',
      3: 'Scenario Options',
      7: 'Variants',
      4: 'Player Count',
      5: 'Player Names',
      6: 'Color Assignment',
    };

    // â”€â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function startGameSetup() {
      const home = document.getElementById('screen-home');
      home.classList.add('hidden');
      home.classList.remove('anim-forward', 'anim-back');

      document.getElementById('progress-wrap').classList.remove('hidden');

      const s1 = document.getElementById('step-1');
      s1.classList.remove('hidden', 'anim-forward', 'anim-back');
      void s1.offsetWidth;
      s1.classList.add('anim-forward');

      st.step = 1;
      st.dir = 'forward';
      updateProgress();
      onEnter(1);
    }

    function goToHome() {
      // Hide current step and progress
      const cur = document.getElementById('step-' + st.step);
      if (cur) { cur.classList.add('hidden'); cur.classList.remove('anim-forward','anim-back'); }
      document.getElementById('progress-wrap').classList.add('hidden');

      // Reset state
      st = { step: 1, modules: new Set(['core']), scenario: null, subOption: null,
             variants: new Set(), playerCount: 2, savedNames: [], assignedColors: null, dir: 'forward' };

      // Show home
      const home = document.getElementById('screen-home');
      home.classList.remove('hidden');
      void home.offsetWidth;
      home.classList.add('anim-back');
    }

    // â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let st = {
      step: 1,
      modules: new Set(['core']),
      scenario: null,
      subOption: null,
      variants: new Set(),
      playerCount: 2,
      savedNames: [],
      assignedColors: null,
      dir: 'forward',
    };

    // â”€â”€â”€ STEP SEQUENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function stepSeq() {
      const s = [1, 2];
      if (st.scenario && st.scenario.subOptions) s.push(3);
      s.push(7, 4, 5, 6);
      return s;
    }

    function nextStep() {
      const s = stepSeq(), i = s.indexOf(st.step);
      return i < s.length - 1 ? s[i + 1] : null;
    }

    function prevStep() {
      const s = stepSeq(), i = s.indexOf(st.step);
      return i > 0 ? s[i - 1] : null;
    }

    // â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function goNext() {
      if (!validate(st.step)) return;
      if (st.step === 5) collectNames();
      const n = nextStep();
      if (n === null) return;
      st.dir = 'forward';
      showStep(n);
    }

    function goBack() {
      const p = prevStep();
      if (p === null) return;
      st.dir = 'back';
      showStep(p);
    }

    function showStep(to) {
      const from = document.getElementById('step-' + st.step);
      const dest = document.getElementById('step-' + to);
      from.classList.add('hidden');
      from.classList.remove('anim-forward', 'anim-back');
      st.step = to;
      dest.classList.remove('hidden', 'anim-forward', 'anim-back');
      void dest.offsetWidth; // reflow
      dest.classList.add(st.dir === 'forward' ? 'anim-forward' : 'anim-back');
      updateProgress();
      onEnter(to);
    }

    function updateProgress() {
      const seq   = stepSeq();
      const pos   = seq.indexOf(st.step) + 1;
      const total = seq.length;
      document.getElementById('prog-num').textContent   = pos;
      document.getElementById('prog-total').textContent = total;
      document.getElementById('prog-name').textContent  = STEP_NAMES[st.step];
      document.getElementById('prog-fill').style.width  = ((pos / total) * 100) + '%';
    }

    function onEnter(step) {
      if (step === 1) renderModules();
      if (step === 2) renderScenarios();
      if (step === 3) renderSubOptions();
      if (step === 7) renderVariants();
      if (step === 4) setupCount();
      if (step === 5) renderNames();
      if (step === 6) renderResults();
    }

    // â”€â”€â”€ VALIDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function validate(step) {
      if (step === 2 && !st.scenario)  { alert('Please select a scenario to continue.'); return false; }
      if (step === 3 && !st.subOption) { alert('Please choose an option to continue.');  return false; }
      return true;
    }

    // â”€â”€â”€ STEP 1: MODULES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderModules() {
      const el = document.getElementById('module-list');
      el.innerHTML = '';
      MODULES.forEach(mod => {
        const checked     = st.modules.has(mod.id);
        const isDisabled  = !!mod.alwaysOn;
        const isComingSoon = !!mod.comingSoon;

        const item = document.createElement('div');
        item.className = 'module-item'
          + (checked      ? ' is-checked'     : '')
          + (isDisabled   ? ' is-disabled'    : '')
          + (isComingSoon ? ' is-coming-soon' : '');

        if (!isDisabled && !isComingSoon) {
          item.addEventListener('click', () => toggleModule(mod.id));
        }

        let badge = '';
        if (isDisabled)   badge = '<span class="mod-badge badge-core">Always On</span>';
        if (isComingSoon) badge = '<span class="mod-badge badge-coming-soon">Coming Soon</span>';

        item.innerHTML = `
          <div class="mod-checkbox"><div class="mod-checkbox-inner"></div></div>
          <div class="mod-text">
            <div class="mod-name-row">
              <span class="mod-name">${mod.label}</span>${badge}
            </div>
            <div class="mod-desc">${mod.desc}</div>
          </div>`;
        el.appendChild(item);
      });
    }

    function toggleModule(id) {
      if (st.modules.has(id)) {
        st.modules.delete(id);
      } else {
        st.modules.add(id);
      }
      // Invalidate scenario if it's no longer compatible
      if (st.scenario && !st.scenario.compat(st.modules)) {
        st.scenario  = null;
        st.subOption = null;
      }
      renderModules();
    }

    // â”€â”€â”€ STEP 2: SCENARIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderScenarios() {
      const grid = document.getElementById('scenario-grid');
      grid.innerHTML = '';

      const compatible = SCENARIOS.filter(s => s.compat(st.modules));

      // Build ordered group list preserving first-seen order
      const groupOrder = [];
      const groups = {};
      compatible.forEach(sc => {
        const g = sc.group || 'Other';
        if (!groups[g]) { groups[g] = []; groupOrder.push(g); }
        groups[g].push(sc);
      });

      groupOrder.forEach(groupName => {
        const hdr = document.createElement('div');
        hdr.className = 'sc-group-header';
        hdr.textContent = groupName;
        grid.appendChild(hdr);

        groups[groupName].forEach(scenario => {
          const sel  = st.scenario && st.scenario.id === scenario.id;
          const card = document.createElement('div');
          card.className = 'scenario-card' + (sel ? ' is-selected' : '');
          card.addEventListener('click', () => selectScenario(scenario));

          const tagLabel = scenario.tag === 'SoloCoop' ? 'Solo/Coop'
                         : scenario.tag === 'Module5'  ? 'Module 5'
                         : scenario.tag;
          card.innerHTML = `
            <div class="sc-radio"><div class="sc-radio-dot"></div></div>
            <div class="sc-text">
              <div class="sc-name">${scenario.name}</div>
              <div class="sc-desc">${scenario.desc}</div>
            </div>
            <div class="sc-actions">
              <button class="btn-inline-rules" onclick="event.stopPropagation(); openScenarioRules('${scenario.id}')" title="View rules for ${esc(scenario.name)}">ğŸ“–</button>
              <div class="sc-tag tag-${scenario.tag}">${tagLabel}</div>
            </div>`;
          grid.appendChild(card);
        });
      });

      document.getElementById('next-2').disabled = !st.scenario;
    }

    function selectScenario(scenario) {
      if (!st.scenario || st.scenario.id !== scenario.id) st.subOption = null;
      st.scenario = scenario;
      renderScenarios();
    }

    // â”€â”€â”€ STEP 3: SUB-OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderSubOptions() {
      if (!st.scenario || !st.scenario.subOptions) return;
      document.getElementById('sub-heading').textContent = st.scenario.name + ' â€” Options';

      const list = document.getElementById('suboption-list');
      list.innerHTML = '';

      st.scenario.subOptions.forEach(opt => {
        const sel  = st.subOption === opt.id;
        const item = document.createElement('div');
        item.className = 'suboption-item' + (sel ? ' is-selected' : '');
        item.addEventListener('click', () => {
          st.subOption = opt.id;
          renderSubOptions();
        });
        item.innerHTML = `
          <div class="sub-radio"><div class="sub-radio-dot"></div></div>
          <div class="sub-text">
            <div class="sub-label">${opt.label}</div>
            <div class="sub-desc">${opt.desc}</div>
          </div>`;
        list.appendChild(item);
      });

      document.getElementById('next-3').disabled = !st.subOption;
    }

    // â”€â”€â”€ STEP 7: VARIANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderVariants() {
      const list = document.getElementById('variant-list');
      list.innerHTML = '';

      const applicable = VARIANTS.filter(v => v.requires(st.modules));

      if (applicable.length === 0) {
        const msg = document.createElement('p');
        msg.style.cssText = 'color:var(--muted);font-size:0.9rem;text-align:center;padding:20px 0';
        msg.textContent = 'No optional variants apply to your current module selection.';
        list.appendChild(msg);
        return;
      }

      applicable.forEach(variant => {
        const checked = st.variants.has(variant.id);
        const item    = document.createElement('div');
        item.className = 'module-item' + (checked ? ' is-checked' : '');
        item.addEventListener('click', () => toggleVariant(variant.id));
        item.innerHTML = `
          <div class="mod-checkbox"><div class="mod-checkbox-inner"></div></div>
          <div class="mod-text">
            <div class="mod-name-row">
              <span class="mod-name">${variant.label}</span>
              <button class="btn-inline-rules" onclick="event.stopPropagation(); openVariantRules('${variant.id}')" title="View rules for ${esc(variant.label)}">ğŸ“–</button>
            </div>
            <div class="mod-desc">${variant.desc}</div>
          </div>`;
        list.appendChild(item);
      });
    }

    function toggleVariant(id) {
      if (st.variants.has(id)) {
        st.variants.delete(id);
      } else {
        st.variants.add(id);
      }
      renderVariants();
    }

    // â”€â”€â”€ STEP 4: PLAYER COUNT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function setupCount() {
      const minP = st.scenario ? st.scenario.minPlayers : 1;
      const maxP = st.scenario ? st.scenario.maxPlayers : 6;
      st.playerCount = Math.max(minP, Math.min(maxP, st.playerCount));

      const sub = document.getElementById('count-subheading');
      const ui  = document.getElementById('count-ui');

      if (minP === maxP) {
        sub.textContent = minP === 1 ? 'This is a solo scenario.' : `This scenario is for exactly ${minP} players.`;
        ui.innerHTML = `
          <div class="count-locked-note">
            <span class="count-locked-num">${minP}</span>
            ${minP === 1 ? 'Solo only' : `${minP} players required`}
          </div>`;
      } else {
        sub.textContent = `Choose between ${minP} and ${maxP} players.`;
        ui.innerHTML = `
          <div class="player-count-row">
            <button class="count-btn" id="btn-minus" onclick="changeCount(-1)">âˆ’</button>
            <div id="count-display">${st.playerCount}</div>
            <button class="count-btn" id="btn-plus"  onclick="changeCount(1)">+</button>
          </div>`;
        syncCountBtns(minP, maxP);
      }
    }

    function changeCount(delta) {
      const minP = st.scenario ? st.scenario.minPlayers : 1;
      const maxP = st.scenario ? st.scenario.maxPlayers : 6;
      st.playerCount = Math.max(minP, Math.min(maxP, st.playerCount + delta));
      document.getElementById('count-display').textContent = st.playerCount;
      syncCountBtns(minP, maxP);
    }

    function syncCountBtns(minP, maxP) {
      const m = document.getElementById('btn-minus');
      const p = document.getElementById('btn-plus');
      if (m) m.disabled = st.playerCount <= minP;
      if (p) p.disabled = st.playerCount >= maxP;
    }

    // â”€â”€â”€ STEP 5: PLAYER NAMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderNames() {
      const container = document.getElementById('name-fields');
      container.innerHTML = '';
      for (let i = 0; i < st.playerCount; i++) {
        const wrap  = document.createElement('div');
        wrap.className = 'name-input-wrap';
        wrap.style.animationDelay = (i * 0.05) + 's';

        const dot   = document.createElement('div');
        dot.className = 'player-dot';

        const input = document.createElement('input');
        input.className   = 'name-input';
        input.type        = 'text';
        input.placeholder = 'Player ' + (i + 1);
        input.value       = st.savedNames[i] || '';
        input.maxLength   = 20;

        wrap.appendChild(dot);
        wrap.appendChild(input);
        container.appendChild(wrap);
      }
    }

    function collectNames() {
      st.savedNames = [...document.querySelectorAll('#name-fields .name-input')]
        .map((inp, i) => inp.value.trim() || 'Player ' + (i + 1));
    }

    // â”€â”€â”€ STEP 6: RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderResults() {
      // Build summary line
      const parts = [st.scenario.name];
      if (st.subOption) {
        const opt = st.scenario.subOptions.find(o => o.id === st.subOption);
        if (opt) parts.push(opt.label);
      }
      const modLabels = [...st.modules]
        .filter(m => m !== 'core')
        .map(m => MODULES.find(mod => mod.id === m)?.label)
        .filter(Boolean);
      if (modLabels.length) parts.push(modLabels.join(', '));
      parts.push(st.playerCount + ' player' + (st.playerCount !== 1 ? 's' : ''));
      document.getElementById('game-summary').textContent = parts.join(' Â· ');

      // Assign colors â€” shuffle once per visit; store so viewCrewCards() can reuse
      if (!st.assignedColors || st.assignedColors.length !== st.playerCount) {
        st.assignedColors = shuffle(COLORS).slice(0, st.playerCount);
      }
      const list = document.getElementById('player-list');
      list.innerHTML = '';

      st.savedNames.forEach((name, i) => {
        const color = st.assignedColors[i];
        const card  = document.createElement('div');
        card.className = 'player-card';
        card.style.cssText = `background:${color.hex}18; border:1.5px solid ${color.hex}55; animation-delay:${i * 0.08}s`;

        const textColor = color.dark ? '#1a1a2e' : 'white';
        card.innerHTML = `
          <div class="color-swatch" style="background:${color.hex}; box-shadow:0 0 18px ${color.shadow}"></div>
          <div class="player-info">
            <div class="player-name">${esc(name)}</div>
            <div class="color-name">${color.name}</div>
          </div>
          <div class="player-card-right">
            <div class="color-badge" style="background:${color.hex}; color:${textColor}">${color.name}</div>
            <button class="btn-crew-cards" onclick="viewCrewCards('${color.name}')">ğŸƒ Crew Cards</button>
          </div>`;
        list.appendChild(card);
      });
    }

    // â”€â”€â”€ CREW CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // Exact card counts per color, from rules/images/Crew Cards/
    const CREW_CARD_COUNTS = { White: 5, Yellow: 5, Green: 4, Grey: 4, Red: 4, Purple: 4 };

    function viewCrewCards(colorName) {
      // Hide step-6 and the progress bar; show the crew cards screen
      document.getElementById('step-6').classList.add('hidden');
      document.getElementById('progress-wrap').classList.add('hidden');

      document.getElementById('crew-cards-heading').textContent = colorName + ' â€” Crew Cards';
      document.getElementById('crew-cards-sub').textContent =
        'Review your ' + colorName + ' faction crew cards, then choose which side to play.';

      const grid = document.getElementById('crew-grid');
      grid.innerHTML = '';
      const count = CREW_CARD_COUNTS[colorName] || 4;
      for (let i = 1; i <= count; i++) {
        const img = document.createElement('img');
        img.className = 'crew-img';
        img.src = 'rules/images/Crew Cards/' + colorName + i + '.png';
        img.alt  = colorName + ' Crew Card ' + i;
        img.loading = 'lazy';
        grid.appendChild(img);
      }

      const screen = document.getElementById('screen-crew-cards');
      screen.classList.remove('hidden', 'anim-forward', 'anim-back');
      void screen.offsetWidth;
      screen.classList.add('anim-forward');
    }

    function closeCrewCards() {
      const screen = document.getElementById('screen-crew-cards');
      screen.classList.add('hidden');
      screen.classList.remove('anim-forward', 'anim-back');

      document.getElementById('progress-wrap').classList.remove('hidden');

      const step6 = document.getElementById('step-6');
      step6.classList.remove('hidden', 'anim-forward', 'anim-back');
      void step6.offsetWidth;
      step6.classList.add('anim-back');
    }

    // â”€â”€â”€ RULES & PLAYER AIDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openRulesAndAids() {
      document.getElementById('step-6').classList.add('hidden');
      document.getElementById('progress-wrap').classList.add('hidden');

      const screen = document.getElementById('screen-rules-and-aids');
      screen.classList.remove('hidden', 'anim-forward', 'anim-back');
      void screen.offsetWidth;
      screen.classList.add('anim-forward');
    }

    function closeRulesAndAids() {
      document.getElementById('screen-rules-and-aids').classList.add('hidden');

      document.getElementById('progress-wrap').classList.remove('hidden');

      const step6 = document.getElementById('step-6');
      step6.classList.remove('hidden', 'anim-forward', 'anim-back');
      void step6.offsetWidth;
      step6.classList.add('anim-back');
    }

    function openRulesFromAids() {
      document.getElementById('screen-rules-and-aids').classList.add('hidden');

      _rulesViewerMode = 'session';
      _renderRulesViewer();

      const screen = document.getElementById('screen-rules-viewer');
      screen.classList.remove('hidden', 'anim-forward', 'anim-back');
      void screen.offsetWidth;
      screen.classList.add('anim-forward');
    }

    // â”€â”€â”€ RULES VIEWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let _rulesViewerMode  = 'session'; // 'session' | 'complete'
    let _rulesViewerRules = [];

    function _getSessionRules() {
      const moduleMap  = { m0:0, m1:1, m2:2, m3:3, m4:4, m5:5 };
      const moduleNums = [...st.modules].filter(m => m !== 'core').map(m => moduleMap[m]).filter(n => n !== undefined);
      const scenarioName = (st.scenario && st.scenario.name) ? st.scenario.name : 'all';
      const variantList  = [...st.variants];
      return {
        rules: buildSessionRulebook({ modules: moduleNums, scenario: scenarioName, variants: variantList }),
        moduleNums,
        scenarioName,
        variantList,
      };
    }

    function _getAllRules() {
      // Return every rule in RULES_DB unfiltered
      return RULES_DB.map(r => ({
        id: r.id,
        title: r.title,
        text: r.text,
        _group: r.modules.length === 0 ? 'Core Rules' : 'Module ' + r.modules[0],
      }));
    }

    function _renderRulesViewer() {
      const title  = document.getElementById('rules-viewer-title');
      const banner = document.getElementById('rules-viewer-banner');
      const search = document.getElementById('rules-viewer-search');
      const btnS   = document.getElementById('toggle-session');
      const btnC   = document.getElementById('toggle-complete');

      btnS.classList.toggle('is-active', _rulesViewerMode === 'session');
      btnC.classList.toggle('is-active', _rulesViewerMode === 'complete');
      search.value = '';

      if (_rulesViewerMode === 'session') {
        title.textContent = 'Session Rules';
        const cfg = _getSessionRules();
        _rulesViewerRules = cfg.rules;

        const moduleLabels = { 0:'Module 0', 1:'Module 1', 2:'Module 2', 3:'Module 3', 4:'Module 4', 5:'Module 5' };
        const tags = ['Core Game'];
        cfg.moduleNums.forEach(n => tags.push(moduleLabels[n] || 'Module ' + n));
        if (cfg.scenarioName && cfg.scenarioName !== 'all') tags.push('Scenario: ' + cfg.scenarioName);
        cfg.variantList.forEach(v => tags.push('Variant: ' + v));

        banner.classList.remove('hidden');
        banner.innerHTML =
          '<div class="rulebook-banner-title">ACTIVE CONFIGURATION</div>' +
          '<div class="rulebook-banner-tags">' +
            tags.map(t => '<span class="rulebook-tag">' + esc(t) + '</span>').join('') +
          '</div>';
      } else {
        title.textContent = 'Complete Game Rules';
        _rulesViewerRules = _getAllRules();

        banner.classList.remove('hidden');
        banner.innerHTML =
          '<div class="rulebook-banner-title">COMPLETE RULEBOOK</div>' +
          '<div class="rulebook-banner-tags">' +
            '<span class="rulebook-tag">All Modules</span>' +
            '<span class="rulebook-tag">All Rules</span>' +
          '</div>';
      }

      _renderRulesViewerList(_rulesViewerRules);
    }

    function setRulesMode(mode) {
      if (_rulesViewerMode === mode) return;
      _rulesViewerMode = mode;
      _renderRulesViewer();
    }

    function filterRulesViewer(query) {
      const q = query.trim().toLowerCase();
      if (!q) { _renderRulesViewerList(_rulesViewerRules); return; }
      const filtered = _rulesViewerRules.filter(r =>
        r.id.toLowerCase().includes(q) ||
        r.title.toLowerCase().includes(q) ||
        r.text.toLowerCase().includes(q)
      );
      _renderRulesViewerList(filtered);
    }

    function _renderRulesViewerList(rules) {
      const container = document.getElementById('rules-viewer-list');
      if (!rules.length) {
        container.innerHTML = '<p class="rulebook-empty">No rules match your search.</p>';
        return;
      }
      const sections = [];
      const groups   = new Map();
      rules.forEach(r => {
        const key = r._group || (r.modules && r.modules.length > 0 ? 'Module ' + r.modules[0] : 'Core Rules');
        if (!groups.has(key)) { groups.set(key, []); sections.push(key); }
        groups.get(key).push(r);
      });
      container.innerHTML = sections.map(key =>
        '<div class="rulebook-section-heading">' + esc(key) + '</div>' +
        groups.get(key).map(r =>
          '<div class="rule-card">' +
            '<div class="rule-card-id">' + esc(r.id) + '</div>' +
            '<div class="rule-card-title">' + esc(r.title) + '</div>' +
            '<div class="rule-card-text">' + esc(r.text) + '</div>' +
          '</div>'
        ).join('')
      ).join('');
    }

    function closeRulesViewer() {
      document.getElementById('screen-rules-viewer').classList.add('hidden');

      const screen = document.getElementById('screen-rules-and-aids');
      screen.classList.remove('hidden', 'anim-forward', 'anim-back');
      void screen.offsetWidth;
      screen.classList.add('anim-back');
    }

    function openPlayerAidsFromAids() {
      // Placeholder â€” screen not built yet
    }

    // â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function resetApp() {
      const from = document.getElementById('step-' + st.step);
      from.classList.add('hidden');
      from.classList.remove('anim-forward', 'anim-back');

      document.getElementById('progress-wrap').classList.add('hidden');

      st = {
        step: 1,
        modules: new Set(['core']),
        scenario: null,
        subOption: null,
        variants: new Set(),
        playerCount: 2,
        savedNames: [],
        assignedColors: null,
        dir: 'forward',
      };

      const home = document.getElementById('screen-home');
      home.classList.remove('hidden', 'anim-forward', 'anim-back');
      void home.offsetWidth;
      home.classList.add('anim-back');
    }

    // â”€â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function esc(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // â”€â”€â”€ SESSION RULEBOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let _rulebookRules    = [];
    let _rulebookCameFrom = 'home'; // 'home' | 'step-6'

    function _showRulebookScreen(rules, bannerFn) {
      _rulebookRules = rules;
      bannerFn();
      document.getElementById('rulebook-search').value = '';
      renderRulebookList(_rulebookRules);
      const screen = document.getElementById('screen-rulebook');
      screen.classList.remove('hidden', 'anim-forward', 'anim-back');
      void screen.offsetWidth;
      screen.classList.add('anim-forward');
    }

    function openRulebook() {
      _rulebookCameFrom = 'home';
      const moduleMap  = { m0:0, m1:1, m2:2, m3:3, m4:4, m5:5 };
      const moduleNums = [...st.modules].filter(m => m !== 'core').map(m => moduleMap[m]).filter(n => n !== undefined);
      const scenarioName = (st.scenario && st.scenario.name) ? st.scenario.name : 'all';
      const variantList  = [...st.variants];
      document.getElementById('screen-home').classList.add('hidden');
      _showRulebookScreen(
        buildSessionRulebook({ modules: moduleNums, scenario: scenarioName, variants: variantList }),
        () => renderRulebookBanner(moduleNums, scenarioName, variantList)
      );
    }

    function openFullRulebook() {
      _rulebookCameFrom = 'home';
      document.getElementById('screen-home').classList.add('hidden');

      // Show screen immediately with a loading state
      document.getElementById('rulebook-banner').innerHTML =
        '<div class="rulebook-banner-title">COMPLETE RULEBOOK</div>' +
        '<div class="rulebook-banner-tags">' +
          '<span class="rulebook-tag">All Modules</span>' +
          '<span class="rulebook-tag">All Scenarios</span>' +
        '</div>';
      document.getElementById('rulebook-search').value = '';
      document.getElementById('rulebook-list').innerHTML = '<p class="rulebook-empty">Loadingâ€¦</p>';
      const screen = document.getElementById('screen-rulebook');
      screen.classList.remove('hidden', 'anim-forward', 'anim-back');
      void screen.offsetWidth;
      screen.classList.add('anim-forward');

      const FILES = [
        { file: 'rules/core_rules.json',      label: 'Core Rules' },
        { file: 'rules/m1_terawatt.json',     label: 'Module 1 â€” Terawatt & Futures' },
        { file: 'rules/m2_colonization.json', label: 'Module 2 â€” Colonization' },
        { file: 'rules/m3_conflict.json',     label: 'Module 3 â€” Conflict' },
        { file: 'rules/m4_exodus.json',       label: 'Module 4 â€” Exodus' },
        { file: 'rules/m5_economy.json',      label: 'Module 5 â€” Economy' },
        { file: 'rules/glossary.json',        label: 'Glossary' },
        { file: 'rules/appendix.json',        label: 'Appendix' },
      ];

      Promise.all(FILES.map(f =>
        fetch(f.file).then(r => r.json()).then(data => ({ label: f.label, data }))
      )).then(results => {
        const allRules = [];
        results.forEach(({ label, data }) => {
          if (Array.isArray(data.sections)) {
            data.sections.forEach(s => allRules.push({ id: s.id, title: s.title, text: s.text, _group: label }));
          } else if (Array.isArray(data.entries)) {
            data.entries.forEach(e => allRules.push({ id: e.term[0].toUpperCase(), title: e.term, text: e.definition, _group: label }));
          }
        });
        _rulebookRules = allRules;
        renderRulebookList(_rulebookRules);
      }).catch(() => {
        document.getElementById('rulebook-list').innerHTML =
          '<p class="rulebook-empty">Failed to load rules. Ensure the app is served over HTTP.</p>';
      });
    }

    function openRulebookFromGame() {
      _rulebookCameFrom = 'step-6';
      const moduleMap  = { m0:0, m1:1, m2:2, m3:3, m4:4, m5:5 };
      const moduleNums = [...st.modules].filter(m => m !== 'core').map(m => moduleMap[m]).filter(n => n !== undefined);
      const scenarioName = (st.scenario && st.scenario.name) ? st.scenario.name : 'all';
      const variantList  = [...st.variants];
      document.getElementById('step-6').classList.add('hidden');
      document.getElementById('progress-wrap').classList.add('hidden');
      _showRulebookScreen(
        buildSessionRulebook({ modules: moduleNums, scenario: scenarioName, variants: variantList }),
        () => renderRulebookBanner(moduleNums, scenarioName, variantList)
      );
    }

    function closeRulebook() {
      document.getElementById('screen-rulebook').classList.add('hidden');
      if (_rulebookCameFrom === 'step-6') {
        document.getElementById('progress-wrap').classList.remove('hidden');
        const step6 = document.getElementById('step-6');
        step6.classList.remove('hidden', 'anim-forward', 'anim-back');
        void step6.offsetWidth;
        step6.classList.add('anim-back');
      } else {
        const home = document.getElementById('screen-home');
        home.classList.remove('hidden', 'anim-forward', 'anim-back');
        void home.offsetWidth;
        home.classList.add('anim-back');
      }
    }

    function renderRulebookBanner(moduleNums, scenarioName, variantList) {
      const moduleLabels = { 0:'Module 0', 1:'Module 1', 2:'Module 2', 3:'Module 3', 4:'Module 4', 5:'Module 5' };
      const tags = ['Core Game'];
      moduleNums.forEach(n => tags.push(moduleLabels[n] || 'Module ' + n));
      if (scenarioName && scenarioName !== 'all') tags.push('Scenario: ' + scenarioName);
      variantList.forEach(v => tags.push('Variant: ' + v));
      document.getElementById('rulebook-banner').innerHTML =
        '<div class="rulebook-banner-title">ACTIVE CONFIGURATION</div>' +
        '<div class="rulebook-banner-tags">' +
          tags.map(t => '<span class="rulebook-tag">' + esc(t) + '</span>').join('') +
        '</div>';
    }

    function filterRulebook(query) {
      const q = query.trim().toLowerCase();
      if (!q) { renderRulebookList(_rulebookRules); return; }
      const filtered = _rulebookRules.filter(r =>
        r.id.toLowerCase().includes(q) ||
        r.title.toLowerCase().includes(q) ||
        r.text.toLowerCase().includes(q)
      );
      renderRulebookList(filtered);
    }

    function renderRulebookList(rules) {
      const container = document.getElementById('rulebook-list');
      if (!rules.length) {
        container.innerHTML = '<p class="rulebook-empty">No rules match your search.</p>';
        return;
      }
      // Group by module origin
      const sections = [];
      const groups   = new Map();
      rules.forEach(r => {
        const key = r._group || (r.modules && r.modules.length > 0 ? 'Module ' + r.modules[0] : 'Core Rules');
        if (!groups.has(key)) { groups.set(key, []); sections.push(key); }
        groups.get(key).push(r);
      });
      container.innerHTML = sections.map(key =>
        '<div class="rulebook-section-heading">' + esc(key) + '</div>' +
        groups.get(key).map(r =>
          '<div class="rule-card">' +
            '<div class="rule-card-id">' + esc(r.id) + '</div>' +
            '<div class="rule-card-title">' + esc(r.title) + '</div>' +
            '<div class="rule-card-text">' + esc(r.text) + '</div>' +
          '</div>'
        ).join('')
      ).join('');
    }

    // â”€â”€â”€ RULES MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // Map scenario IDs to search terms for finding relevant rules
    const SCENARIO_RULE_KEYWORDS = {
      'space-diamonds':   ['Space Diamonds', 'diamond'],
      'race-for-glory':   ['Race for Glory', 'race for glory', 'walkthrough'],
      'standard':         ['Standard Game', 'standard game'],
      'quick-start':      ['Quick Start', 'V1'],
      'race-to-saturn':   ['Race to Saturn', 'V2', 'Titan'],
      'grand-tour':       ['Grand Tour', 'V3'],
      'red-giant':        ['Red Giant', 'V10'],
      'diamonds-4-all':   ['Diamonds 4 All', 'V11', 'discovery chit'],
      'panspermia':       ['Panspermia', 'V12', 'alien species'],
      'altruism':         ['Altruism', 'V4', 'cooperative'],
      'hermes-fall':      ['Hermes Fall', 'V5', 'Hermes'],
      'ceo':              ['CEO', 'V6', 'KPI', 'board meeting'],
      'bios-earth':       ['Bios:Earth', 'Bios Earth', 'V7', 'Bios:Origins'],
      'bios-venus-mars':  ['Bios:Venus', 'Bios:Mars', 'V8'],
      'sirens':           ['Sirens', 'V9', 'Uranus'],
      'wernersstar':      ["Werner's Star", 'Werner', 'TW thruster'],
      'exodus-scenarios': ['Exodus', 'starship', 'Independence'],
      'iso-dawn':         ['Iso Dawn', 'isotope monetization'],
      'taurus':           ["Roger's Taurus", 'Taurus', 'NPC'],
    };

    const VARIANT_RULE_KEYWORDS = {
      'rapid-start':            ['Rapid Start', 'patent auction'],
      'diamonds-overlay':       ['Diamonds 4 All', 'discovery chit'],
      'asteroid-jormungandr':   ['Jormungandr', 'asteroid tile'],
      'habitable-venus':        ['Habitable Venus', 'Venus overlay'],
      'alt-solitaire-politics': ['Alternative Solitaire', 'political diagram', 'solitaire politics'],
      'm5-short':               ['Short Game', 'Seniority Disk'],
      'm5-jumpstart':           ['Jump Start', 'Iso Dawn faction table'],
    };

    // Returns only the JSON files for currently selected modules
    function _getActiveModuleFiles() {
      const ALL_FILES = [
        { file: 'rules/core_rules.json',      label: 'Core Rules',                      mod: 'core' },
        { file: 'rules/m1_terawatt.json',     label: 'Module 1 â€” Terawatt & Futures',   mod: 'm1'   },
        { file: 'rules/m2_colonization.json', label: 'Module 2 â€” Colonization',          mod: 'm2'   },
        { file: 'rules/m3_conflict.json',     label: 'Module 3 â€” Conflict',              mod: 'm3'   },
        { file: 'rules/m4_exodus.json',       label: 'Module 4 â€” Exodus',                mod: 'm4'   },
        { file: 'rules/m5_economy.json',      label: 'Module 5 â€” Economy',               mod: 'm5'   },
        { file: 'rules/appendix.json',        label: 'Appendix',                         mod: null   },
      ];
      return ALL_FILES.filter(f => f.mod === null || st.modules.has(f.mod));
    }

    // â”€â”€â”€ STEP 7: VARIANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderVariants() {
      const el = document.getElementById('variant-list');
      el.innerHTML = '';

      const activeScenarioId = st.scenario ? st.scenario.id : null;

      // Group definitions with display labels and accent colors
      const GROUP_META = {
        'auction':   { label: 'ğŸƒ Card Auctions & Market',        color: '#e8f4fd', border: '#3498db' },
        'quick-start': { label: 'âš¡ Quick Start',                 color: '#fef9e7', border: '#f1c40f' },
        'general':   { label: 'âš™ï¸ General Optional Rules',        color: '#f9f9f9', border: '#bdc3c7' },
        'solitaire': { label: 'ğŸ¯ Solitaire / Cooperative',        color: '#f0faf4', border: '#2ecc71' },
        'm5':        { label: 'ğŸ“ˆ Module 5 â€” Economy',             color: '#fdf2fb', border: '#9b59b6' },
      };

      // Determine which variants to show
      const visibleVariants = VARIANTS.filter(v => {
        if (!v.requires(st.modules)) return false;
        // Scenario-specific variants: only show if that scenario is selected
        if (v.forScenario && v.forScenario !== activeScenarioId) return false;
        return true;
      });

      if (visibleVariants.length === 0) {
        el.innerHTML = '<p class="rulebook-empty">No optional rules available for your current module selection.</p>';
        return;
      }

      // Render by group, auction group first
      const groupOrder = ['auction', 'quick-start', 'general', 'solitaire', 'm5'];
      groupOrder.forEach(groupKey => {
        const groupVariants = visibleVariants.filter(v => v.group === groupKey);
        if (groupVariants.length === 0) return;

        const meta = GROUP_META[groupKey] || { label: groupKey, color: '#f9f9f9', border: '#bdc3c7' };

        const groupEl = document.createElement('div');
        groupEl.className = 'variant-group';
        groupEl.style.cssText = `margin-bottom:18px; border-left:3px solid ${meta.border}; padding-left:12px;`;

        const groupHdr = document.createElement('div');
        groupHdr.className = 'variant-group-label';
        groupHdr.style.cssText = `font-weight:700; font-size:0.78rem; text-transform:uppercase; letter-spacing:0.05em; color:#666; margin-bottom:8px;`;
        groupHdr.textContent = meta.label;
        groupEl.appendChild(groupHdr);

        groupVariants.forEach(v => {
          const checked = st.variants.has(v.id);
          const item = document.createElement('div');
          item.className = 'module-item' + (checked ? ' is-checked' : '');
          item.style.cssText = `background:${checked ? meta.color : '#fff'}; border-color:${checked ? meta.border : '#e5e7eb'};`;
          item.addEventListener('click', () => {
            if (st.variants.has(v.id)) st.variants.delete(v.id);
            else st.variants.add(v.id);
            renderVariants();
          });
          item.innerHTML = `
            <div class="mod-checkbox"><div class="mod-checkbox-inner"></div></div>
            <div class="mod-text">
              <div class="mod-name-row">
                <span class="mod-name">${v.label}</span>
                ${v.forScenario ? '<span class="mod-badge badge-core" style="background:#ffeaa7;color:#856404">Scenario-specific</span>' : ''}
              </div>
              <div class="mod-desc">${v.desc}</div>
            </div>`;
          groupEl.appendChild(item);
        });

        el.appendChild(groupEl);
      });
    }

    

      return Promise.all(FILES.map(f =>
        fetch(f.file).then(r => r.json()).then(data => ({ label: f.label, data }))
      )).then(results => {
        const allRules = [];
        results.forEach(({ label, data }) => {
          if (Array.isArray(data.sections)) {
            data.sections.forEach(s => allRules.push({ id: s.id, title: s.title, text: s.text, _group: label }));
          } else if (Array.isArray(data.entries)) {
            data.entries.forEach(e => allRules.push({ id: e.term[0].toUpperCase(), title: e.term, text: e.definition, _group: label }));
          }
        });
        _allRulesCache = allRules;
        return allRules;
      });
    }

    function _filterRulesByKeywords(allRules, keywords) {
      const lowerKw = keywords.map(k => k.toLowerCase());
      return allRules.filter(r => {
        const haystack = (r.id + ' ' + r.title + ' ' + r.text).toLowerCase();
        return lowerKw.some(kw => haystack.includes(kw));
      });
    }

    function _renderModalRules(rules) {
      const body = document.getElementById('rules-modal-body');
      if (!rules.length) {
        body.innerHTML = '<p class="rulebook-empty">No specific rules found. Try the full Rules Reference from the home screen.</p>';
        return;
      }
      // Group by source
      const sections = [];
      const groups = new Map();
      rules.forEach(r => {
        const key = r._group || 'Rules';
        if (!groups.has(key)) { groups.set(key, []); sections.push(key); }
        groups.get(key).push(r);
      });
      body.innerHTML = sections.map(key =>
        '<div class="rulebook-section-heading">' + esc(key) + '</div>' +
        groups.get(key).map(r =>
          '<div class="rule-card">' +
            '<div class="rule-card-id">' + esc(r.id) + '</div>' +
            '<div class="rule-card-title">' + esc(r.title) + '</div>' +
            '<div class="rule-card-text">' + esc(r.text) + '</div>' +
          '</div>'
        ).join('')
      ).join('');
    }

    function openScenarioRules(scenarioId) {
      const scenario = SCENARIOS.find(s => s.id === scenarioId);
      if (!scenario) return;

      const overlay = document.getElementById('rules-modal-overlay');
      const title   = document.getElementById('rules-modal-title');
      const body    = document.getElementById('rules-modal-body');

      title.textContent = scenario.name + ' â€” Rules';
      body.innerHTML = '<p class="rulebook-empty">Loadingâ€¦</p>';
      overlay.classList.remove('hidden');

      // Only load files for selected modules
      const activeModuleFiles = _getActiveModuleFiles();

      Promise.all(activeModuleFiles.map(f =>
        fetch(f.file).then(r => r.json()).then(data => ({ label: f.label, data }))
      )).then(results => {
        const allRules = [];
        results.forEach(({ label, data }) => {
          if (Array.isArray(data.sections)) {
            data.sections.forEach(s => allRules.push({ id: s.id, title: s.title, text: s.text, _group: label }));
          }
        });

        // Filter to only sections whose IDs match the scenario's ruleIds
        const ruleIds = scenario.ruleIds || [];
        let matched = [];
        if (ruleIds.length > 0) {
          matched = allRules.filter(r => ruleIds.some(rid => r.id === rid || r.id.startsWith(rid)));
        }
        // Fallback: keyword search using scenario name
        if (matched.length === 0) {
          const kw = scenario.name.toLowerCase();
          matched = allRules.filter(r => (r.title + ' ' + r.text).toLowerCase().includes(kw));
        }
        _renderModalRules(matched);
      }).catch(() => {
        body.innerHTML = '<p class="rulebook-empty">Failed to load rules. Ensure the app is served over HTTP.</p>';
      });
    }

    function openVariantRules(variantId) {
      const variant = VARIANTS.find(v => v.id === variantId);
      if (!variant) return;

      const overlay = document.getElementById('rules-modal-overlay');
      const title   = document.getElementById('rules-modal-title');
      const body    = document.getElementById('rules-modal-body');

      title.textContent = variant.label + ' â€” Rules';
      body.innerHTML = '<p class="rulebook-empty">Loadingâ€¦</p>';
      overlay.classList.remove('hidden');

      const ruleIds = variant.ruleIds || [];
      const activeModuleFiles = _getActiveModuleFiles();

      Promise.all(activeModuleFiles.map(f =>
        fetch(f.file).then(r => r.json()).then(data => ({ label: f.label, data }))
      )).then(results => {
        const allRules = [];
        results.forEach(({ label, data }) => {
          if (Array.isArray(data.sections)) {
            data.sections.forEach(s => allRules.push({ id: s.id, title: s.title, text: s.text, _group: label }));
          }
        });
        let matched = [];
        if (ruleIds.length > 0) {
          matched = allRules.filter(r => ruleIds.some(rid => r.id === rid || r.id.startsWith(rid)));
        }
        if (matched.length === 0) {
          const kw = variant.label.toLowerCase();
          matched = allRules.filter(r => (r.title + ' ' + r.text).toLowerCase().includes(kw));
        }
        _renderModalRules(matched);
      }).catch(() => {
        body.innerHTML = '<p class="rulebook-empty">Failed to load rules. Ensure the app is served over HTTP.</p>';
      });
    }

    function closeRulesModal() {
      document.getElementById('rules-modal-overlay').classList.add('hidden');
    }

    // Close modal on Escape key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && !document.getElementById('rules-modal-overlay').classList.contains('hidden')) {
        closeRulesModal();
      }
    });

    // â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Start on the home screen; game setup begins when the user taps "Game Setup"
  </script>

  <script src="rules.js"></script>
</body>
</html>
